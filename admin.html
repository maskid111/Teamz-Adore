<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamz Adore Business Hub - Admin Panel</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary: #f8e1e7;
            --secondary: #d8a1b6;
            --accent: #e83e8c;
            --dark: #3a3a3a;
            --light: #ffffff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .login-logo-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .login-logo-text h1 {
            color: var(--accent);
            font-size: 28px;
            margin: 0;
        }
        
        .login-logo-text p {
            color: #666;
            font-size: 14px;
            margin: 5px 0 0 0;
        }
        
        .google-signin-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background-color 0.3s;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .google-signin-btn:hover {
            background-color: #357ae8;
        }
        
        .google-signin-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .google-icon {
            width: 20px;
            height: 20px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Admin Panel */
        .admin-container {
            display: none;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--dark);
            color: var(--light);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .admin-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-logo-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .admin-logo-text h2 {
            color: var(--accent);
            font-size: 24px;
            margin: 0;
        }
        
        .admin-logo-text p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin: 5px 0 0 0;
        }
        
        .sidebar-nav {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 5px;
        }
        
        .sidebar-nav a {
            display: block;
            padding: 15px 20px;
            color: var(--light);
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background-color: var(--accent);
        }
        
        .sidebar-nav i {
            margin-right: 10px;
            width: 20px;
        }
        
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        
        .header {
            background-color: var(--light);
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: var(--dark);
            font-size: 28px;
        }
        
        .logout-btn {
            background-color: var(--danger);
            color: var(--light);
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background-color: #c82333;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--light);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .stat-card.products i {
            color: var(--accent);
        }
        
        .stat-card.orders i {
            color: var(--success);
        }
        
        .stat-card.revenue i {
            color: var(--warning);
        }
        
        .stat-card.customers i {
            color: var(--secondary);
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            color: #666;
            font-size: 14px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .section-header h2 {
            color: var(--dark);
            font-size: 24px;
        }
        
        .btn {
            background-color: var(--accent);
            color: var(--light);
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background-color: #ce2c78;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .products-table {
            background-color: var(--light);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }
        
        .table tr:hover {
            background-color: #f8f9fa;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--light);
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 20px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .login-card {
                margin: 20px;
                padding: 30px 20px;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .table {
                font-size: 12px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <img src="logo.jpg" alt="Teamz Adore Logo" class="login-logo-img">
                    <div class="login-logo-text">
                        <h1>Teamz Adore Business Hub</h1>
                        <p>Admin Panel Access</p>
                    </div>
                </div>
            </div>
            
            <button class="google-signin-btn" id="googleSignInBtn" onclick="signInWithGoogle()">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                Sign in with Google
            </button>
            
            <div class="loading" id="loginLoading">
                <div class="spinner"></div>
                Signing in...
            </div>
            
            <div id="errorMessage" class="error-message"></div>
            
            <a href="index.html" style="color: #666; text-decoration: none; font-size: 14px;">
                <i class="fas fa-arrow-left"></i> Back to Main Site
            </a>
        </div>
    </div>

    <!-- Admin Panel (hidden until login) -->
    <div class="admin-container" id="adminContainer">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="admin-logo">
                    <img src="logo.jpg" alt="Teamz Adore Logo" class="admin-logo-img">
                    <div class="admin-logo-text">
                        <h2>Teamz Adore Business Hub</h2>
                        <p>Admin Panel</p>
                    </div>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="nav-link active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="products"><i class="fas fa-box"></i>Products</a></li>
                <li><a href="#" class="nav-link" data-section="orders"><i class="fas fa-shopping-cart"></i>Orders</a></li>
                <li><a href="#" class="nav-link" data-section="settings"><i class="fas fa-cog"></i>Settings</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 id="page-title">Dashboard</h1>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card products">
                        <i class="fas fa-box"></i>
                        <h3 id="total-products">0</h3>
                        <p>Total Products</p>
                    </div>
                    <div class="stat-card orders">
                        <i class="fas fa-shopping-cart"></i>
                        <h3 id="total-orders">0</h3>
                        <p>Total Orders</p>
                    </div>
                    <div class="stat-card revenue">
                        <i class="fas fa-dollar-sign"></i>
                        <h3 id="total-revenue">₦0</h3>
                        <p>Total Revenue</p>
                    </div>
                    <div class="stat-card customers">
                        <i class="fas fa-users"></i>
                        <h3 id="total-customers">0</h3>
                        <p>Total Customers</p>
                    </div>
                </div>
            </section>

            <!-- Products Section -->
            <section id="products" class="content-section">
                <div class="section-header">
                    <h2>Products Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" id="addProductBtn" onclick="openAddProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                        <!-- <button class="btn btn-warning" onclick="testFirebaseConnection()">
                            <i class="fas fa-bug"></i> Test Firebase
                        </button> -->
                    </div>
                </div>
                
                <div class="products-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading products...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders" class="content-section">
                <div class="section-header">
                    <h2>Orders Management</h2>
                </div>
                <div class="loading">
                    <div class="spinner"></div>
                    Orders feature coming soon...
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>Settings</h2>
                </div>
                <div class="loading">
                    <div class="spinner"></div>
                    Settings feature coming soon...
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Product</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Product Name *</label>
                    <input type="text" id="productName" name="name" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategory">Category *</label>
                        <select id="productCategory" name="category" required>
                            <option value="">Select Category</option>
                            <option value="female-shoes">Female Shoes</option>
                            <option value="male-shoes">Male Shoes</option>
                            <option value="bags">Bags</option>
                            <option value="accessories">Accessories</option>
                            <option value="wears">Wears</option>
                            <option value="skincare">Skincare</option>
                            <option value="hair">Hair</option>
                            <option value="perfume">Perfume</option>
                            <option value="fabric">Fabric</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price (₦) *</label>
                        <input type="number" id="productPrice" name="price" min="0" step="100" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productStock">Stock Quantity *</label>
                        <input type="number" id="productStock" name="stock" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productImage">Product Image</label>
                        <input type="file" id="productImage" name="image" accept="image/*">
                        <img id="imagePreview" class="image-preview" alt="Preview">
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Images are stored directly in the database as base64 strings.
                        </small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" name="description" placeholder="Enter product description..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-warning" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success" id="submitBtn">Add Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmDGQC3hsDoHvepmlHkvimX8DUg0X-hYY",
            authDomain: "teamz-adore-d76ad.firebaseapp.com",
            projectId: "teamz-adore-d76ad",
            storageBucket: "teamz-adore-d76ad.firebasestorage.app",
            messagingSenderId: "99067685820",
            appId: "1:99067685820:web:62cda395f0a1ebc99fd9b9"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase initialized successfully');
        } catch (error) {
            console.error('❌ Firebase initialization failed:', error);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        // Configure Firestore settings
        db.settings({
            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
        });

        // Enable offline persistence
        db.enablePersistence({
            synchronizeTabs: true
        }).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            } else if (err.code == 'unimplemented') {
                console.warn('The current browser does not support all the features required for persistence');
            }
        });

        // Add connection state monitoring
        db.enableNetwork().then(() => {
            console.log('✅ Firestore network enabled');
        }).catch((err) => {
            console.error('❌ Firestore network error:', err);
        });

        // Initialize Google Auth Provider
        const provider = new firebase.auth.GoogleAuthProvider();

        // Global variables
        let currentUser = null;
        let editingProductId = null;

        // Authentication
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    showAdminPanel();
                    loadDashboard();
                    loadProducts();
                } else {
                    showLoginForm();
                }
            });
        }

        function showLoginForm() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'flex';
            
            // Attach event listeners after admin panel is shown
            attachEventListeners();
        }

        // Google Sign-In
        async function signInWithGoogle() {
            const signInBtn = document.getElementById('googleSignInBtn');
            const loading = document.getElementById('loginLoading');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                // Show loading state
                signInBtn.style.display = 'none';
                loading.style.display = 'block';
                errorMessage.style.display = 'none';
                
                // Sign in with Google
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error('Google Sign-In Error:', error);
                
                // Show error
                errorMessage.textContent = 'Sign-in failed: ' + error.message;
                errorMessage.style.display = 'block';
                
                // Reset form
                signInBtn.style.display = 'flex';
                loading.style.display = 'none';
            }
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                showLoginForm();
            });
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const productsSnapshot = await db.collection('products').get();
                const totalProducts = productsSnapshot.size;
                
                document.getElementById('total-products').textContent = totalProducts;
                document.getElementById('total-orders').textContent = '0'; // Placeholder
                document.getElementById('total-revenue').textContent = '₦0'; // Placeholder
                document.getElementById('total-customers').textContent = '0'; // Placeholder
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Products functions
        async function loadProducts() {
            try {
                const productsSnapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
                const productsTableBody = document.getElementById('products-table-body');
                
                if (productsSnapshot.empty) {
                    productsTableBody.innerHTML = '<tr><td colspan="6" class="loading">No products found</td></tr>';
                    return;
                }

                productsTableBody.innerHTML = '';
                productsSnapshot.forEach((doc) => {
                    const product = doc.data();
                    const row = createProductRow(doc.id, product);
                    productsTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-table-body').innerHTML = '<tr><td colspan="6" class="loading">Error loading products</td></tr>';
            }
        }

        function createProductRow(id, product) {
            const row = document.createElement('tr');
            
            // Handle both base64 images and placeholder URLs
            let imageSrc = 'https://via.placeholder.com/60x60';
            if (product.imageUrl) {
                if (product.imageUrl.startsWith('data:image/')) {
                    // Base64 image
                    imageSrc = product.imageUrl;
                } else if (product.imageUrl.startsWith('https://via.placeholder.com/')) {
                    // Placeholder URL
                    imageSrc = product.imageUrl;
                } else {
                    // Fallback
                    imageSrc = 'https://via.placeholder.com/60x60';
                }
            }
            
            row.innerHTML = `
                <td><img src="${imageSrc}" alt="${product.name}" class="product-image"></td>
                <td>${product.name}</td>
                <td>${product.category}</td>
                <td>₦${product.price.toLocaleString()}</td>
                <td>${product.stock}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-warning btn-sm" onclick="editProduct('${id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
            return row;
        }

        async function addProduct(productData) {
            console.log('=== addProduct function called ===');
            console.log('Product data to add:', productData);
            console.log('Current user:', currentUser);
            
            try {
                // Check if we're online
                if (!navigator.onLine) {
                    throw new Error('No internet connection. Please check your network and try again.');
                }

                // Try to reconnect to Firestore
                console.log('Ensuring Firestore connection...');
                await db.enableNetwork();
                
                console.log('Adding product to Firebase...');
                const now = new Date();
                const productToAdd = {
                    name: productData.name,
                    category: productData.category,
                    price: productData.price,
                    stock: productData.stock,
                    description: productData.description || '',
                    imageUrl: productData.imageUrl || 'https://via.placeholder.com/300x300?text=No+Image',
                    createdAt: now,
                    updatedAt: now
                };
                
                console.log('Product data to add (cleaned):', productToAdd);
                
                // Add with timeout
                const addPromise = db.collection('products').add(productToAdd);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase operation timed out')), 10000)
                );
                
                const docRef = await Promise.race([addPromise, timeoutPromise]);
                console.log('Product added with ID:', docRef.id);
                
                console.log('Reloading products and dashboard...');
                await loadProducts();
                await loadDashboard();
                
                console.log('Closing modal...');
                closeModal();
                
                console.log('Showing success message...');
                alert('Product added successfully!');
            } catch (error) {
                console.error('Error adding product:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMessage = 'Error adding product: ' + error.message;
                if (error.code === 'unavailable') {
                    errorMessage = 'Firebase is currently unavailable. Please check your internet connection and try again.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please make sure you are signed in and have the correct permissions.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Operation timed out. Please check your internet connection and try again.';
                }
                
                alert(errorMessage);
            }
        }

        async function editProduct(id) {
            try {
                const productDoc = await db.collection('products').doc(id).get();
                if (productDoc.exists) {
                    const product = productDoc.data();
                    editingProductId = id;
                    
                    document.getElementById('modal-title').textContent = 'Edit Product';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('submitBtn').textContent = 'Update Product';
                    
                    // Handle image preview for both base64 and placeholder images
                    if (product.imageUrl) {
                        const preview = document.getElementById('imagePreview');
                        if (product.imageUrl.startsWith('data:image/')) {
                            // Base64 image
                            preview.src = product.imageUrl;
                        } else if (product.imageUrl.startsWith('https://via.placeholder.com/')) {
                            // Placeholder image
                            preview.src = product.imageUrl;
                        } else {
                            // Fallback
                            preview.src = 'https://via.placeholder.com/300x300?text=No+Image';
                        }
                        preview.style.display = 'block';
                    }
                    
                    document.getElementById('productModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading product for edit:', error);
                alert('Error loading product: ' + error.message);
            }
        }

        async function updateProduct(productData) {
            try {
                await db.collection('products').doc(editingProductId).update({
                    ...productData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadProducts();
                loadDashboard();
                closeModal();
                alert('Product updated successfully!');
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Error updating product: ' + error.message);
            }
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await db.collection('products').doc(id).delete();
                    loadProducts();
                    loadDashboard();
                    alert('Product deleted successfully!');
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product: ' + error.message);
                }
            }
        }

        // Convert image file to base64 string
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        // Generate placeholder image URL based on product name
        function generatePlaceholderImage(productName) {
            const encodedName = encodeURIComponent(productName);
            return `https://via.placeholder.com/300x300/ff69b4/ffffff?text=${encodedName}`;
        }

        // Modal functions
        function openAddProductModal() {
            console.log('=== openAddProductModal called ===');
            console.log('Opening add product modal...');
            editingProductId = null;
            
            const modal = document.getElementById('productModal');
            console.log('Modal element:', modal);
            
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal display set to block');
            } else {
                console.error('Modal element not found!');
                return;
            }
            
            document.getElementById('modal-title').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'Add Product';
            console.log('Modal should be visible now');
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        // Form handling
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('=== Form submitted ===');
            
            const formData = new FormData(e.target);
            const productData = {
                name: formData.get('name'),
                category: formData.get('category'),
                price: parseInt(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                description: formData.get('description')
            };

            console.log('Product data:', productData);
            console.log('Editing product ID:', editingProductId);

            // Validate required fields
            if (!productData.name || !productData.category || !productData.price || productData.stock === undefined) {
                alert('Please fill in all required fields (Name, Category, Price, Stock)');
                return;
            }

            if (productData.price <= 0 || productData.stock < 0) {
                alert('Price must be greater than 0 and Stock must be 0 or greater');
                return;
            }

            // Set default image if none provided
            if (!productData.imageUrl) {
                productData.imageUrl = 'https://via.placeholder.com/300x300?text=No+Image';
            }

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;

            // Add timeout to prevent infinite processing
            const timeoutId = setTimeout(() => {
                console.error('Form submission timeout after 60 seconds');
                alert('Form submission timed out. Please try again.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 60000);

            try {
                const imageFile = formData.get('image');
                console.log('Image file:', imageFile);
                
                // Handle image processing
                if (imageFile && imageFile.size > 0) {
                    console.log('Processing image file...');
                    console.log('Image details:', {
                        name: imageFile.name,
                        size: imageFile.size,
                        type: imageFile.type
                    });
                    
                    // Check file size (limit to 2MB to avoid Firestore limits)
                    const maxSize = 2 * 1024 * 1024; // 2MB
                    if (imageFile.size > maxSize) {
                        alert('Image file is too large. Please choose an image smaller than 2MB.');
                        return;
                    }
                    
                    try {
                        console.log('Converting image to base64...');
                        productData.imageUrl = await convertImageToBase64(imageFile);
                        console.log('Image converted to base64 successfully');
                        console.log('Base64 length:', productData.imageUrl.length);
                    } catch (imageError) {
                        console.error('Error converting image:', imageError);
                        alert('Error processing image. Using placeholder instead.');
                        productData.imageUrl = generatePlaceholderImage(productData.name);
                    }
                } else {
                    console.log('No image file provided, using placeholder');
                    productData.imageUrl = generatePlaceholderImage(productData.name);
                }

                if (editingProductId) {
                    console.log('Updating existing product...');
                    await updateProduct(productData);
                } else {
                    console.log('Adding new product...');
                    await addProduct(productData);
                }
            } catch (error) {
                console.error('Error processing product:', error);
                alert('Error processing product: ' + error.message);
            } finally {
                // Clear timeout and reset button state
                clearTimeout(timeoutId);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Image preview functionality
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Attach all event listeners
        function attachEventListeners() {
            console.log('Attaching event listeners...');
            
            // Add Product Button Event Listener
            const addProductBtn = document.getElementById('addProductBtn');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Add product button clicked!');
                    openAddProductModal();
                });
                console.log('Add product button event listener attached successfully');
            } else {
                console.error('Add product button not found!');
            }
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.getAttribute('data-section');
                
                // Update active nav
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                // Show section
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                // Update page title
                document.getElementById('page-title').textContent = section.charAt(0).toUpperCase() + section.slice(1);
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('productModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // Test Firebase connection
        async function testFirebaseConnection() {
            console.log('=== Testing Firebase Connection ===');
            console.log('Current user:', currentUser);
            console.log('Firebase app:', firebase.app());
            console.log('Firestore instance:', db);
            console.log('Online status:', navigator.onLine);
            
            try {
                // Check internet connection
                if (!navigator.onLine) {
                    throw new Error('No internet connection detected');
                }

                // Try to enable network
                console.log('Enabling Firestore network...');
                await db.enableNetwork();
                console.log('✅ Firestore network enabled');

                console.log('Testing basic Firestore write...');
                const testDoc = await db.collection('test').add({
                    test: true,
                    timestamp: new Date(),
                    user: currentUser ? currentUser.uid : 'anonymous'
                });
                console.log('✅ Firebase write test successful! Doc ID:', testDoc.id);
                
                console.log('Testing Firestore read...');
                const doc = await db.collection('test').doc(testDoc.id).get();
                console.log('✅ Firebase read test successful! Data:', doc.data());
                
                console.log('Cleaning up test document...');
                await db.collection('test').doc(testDoc.id).delete();
                console.log('✅ Test document cleaned up');
                
                alert('✅ Firebase connection test successful!');
            } catch (error) {
                console.error('❌ Firebase connection test failed:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMessage = 'Firebase connection test failed: ' + error.message;
                if (error.code === 'unavailable') {
                    errorMessage = 'Firebase is currently unavailable. This could be due to:\n1. Internet connection issues\n2. Firebase service outage\n3. Firestore security rules\n\nPlease check your internet connection and try again.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please make sure you are signed in with Google.';
                }
                
                alert('❌ ' + errorMessage);
            }
        }

        // Initialize app
        checkAuth();
    </script>
</body>
</html>